#!/usr/bin/env python3
import sys
from pathlib import Path

def count_file(path: Path) -> int:
    loc = 0
    in_block_comment = False

    with path.open(encoding="utf-8", errors="ignore") as f:
        for line in f:
            stripped = line.strip()

            # Handle block comments
            if in_block_comment:
                if "*/" in stripped:
                    in_block_comment = False
                continue

            if not stripped:
                continue                  # blank line
            if stripped == "}":
                continue                  # closing brace only
            if stripped.startswith("//"):
                continue                  # single-line comment
            if stripped.startswith("/*"):
                if not stripped.endswith("*/"):
                    in_block_comment = True
                continue                  # block comment line

            loc += 1
    return loc

def count_path(path: Path) -> int:
    if path.is_file():
        if path.name == "index.md":
            return 0
        return count_file(path)

    total = 0
    for p in path.rglob("*"):
        total += count_path(p)
    return total

if __name__ == "__main__":
    print("# LOC metrics")
    print("generated by [loc.py](loc.py)")
    print()
    for casestudy in ["airline", "library", "shop"]:
        print("## " + casestudy)
        print()
        print("### Black-box LLM prompt")
        print(count_path(Path(casestudy + "/blackbox-llm/prompt.md")))
        print()
        print("### Black-box LLM generated code")
        for run in [str(i) for i in range(1, 6)]:
            print("- run " + run + ": " + str(count_path(Path(casestudy + "/blackbox-llm/" + run + "/src"))))        
        print()
        print("### Classical UML models")
        print(count_path(Path(casestudy + "/classical-uml")))
        print()
        print("### MoProCo specification file")
        print(count_path(Path(casestudy + "/moproco/" + casestudy + ".cdiag")))
        print()
        print("### MoProCo generated code")
        for run in [str(i) for i in range(1, 6)]:
            print("- run " + run + ": " + str(count_path(Path(casestudy + "/moproco/" + run + "/src"))))
        print()
        print()
