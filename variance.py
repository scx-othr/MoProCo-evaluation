import os
import itertools
import difflib

def collect_files(root):
    """
    Return a dict mapping relative paths to full paths.
    """
    files = {}
    for dirpath, _, filenames in os.walk(root):
        for fn in filenames:
            rel = os.path.relpath(os.path.join(dirpath, fn), root)
            files[rel] = os.path.join(dirpath, fn)
    return files

def read_or_empty(path):
    """
    Read file lines or return empty list if file doesn't exist.
    """
    try:
        with open(path, encoding="utf-8", errors="ignore") as f:
            return f.readlines()
    except FileNotFoundError:
        return []

def diff_size(lines1, lines2):
    """
    Return a simple diff size metric: number of differing lines.
    """
    diff = difflib.unified_diff(lines1, lines2)
    # Count lines starting with + or - (excluding diff metadata)
    count = sum(1 for l in diff if l.startswith("+ ") or l.startswith("- "))
    if len(lines1) == 0 and len(lines2) == 0:
        return 0
    return count / (len(lines1) + len(lines2))

def compute_pairwise_diff(folders):
    """
    Compute average pairwise diff across all folder pairs.
    """
    # Collect all distinct relative paths
    all_files = set()
    file_maps = [collect_files(f) for f in folders]
    for fm in file_maps:
        all_files |= fm.keys()

    diffs = []
    for (i, j) in itertools.combinations(range(len(folders)), 2):
        total = 0
        for rel in all_files:
            l1 = read_or_empty(file_maps[i].get(rel, ""))
            l2 = read_or_empty(file_maps[j].get(rel, ""))
            total += diff_size(l1, l2)
        diffs.append(total / len(all_files))

    avg = sum(diffs) / len(diffs) if diffs else 0
    return avg, diffs

if __name__ == "__main__":
    print("# Variance metrics")
    print("generated by [variance.py](variance.py)")
    print()
    for casestudy in ["airline", "library", "shop"]:
        print("## " + casestudy)
        print()
        print("### Black-box LLM generated code")
        blackbox_roots = [casestudy + "/blackbox-llm/" + str(i) + "/src" for i in range(1, 6)]
        blackbox_variance, blackbox_diffs = compute_pairwise_diff(blackbox_roots)
        print("Variance:", "{:.4f}".format(blackbox_variance) + "  ")
        print("Pairwise diffs:", ["{:.4f}".format(d) for d in blackbox_diffs])
        print()
        print("### MoProCo generated code")
        moproco_roots = [casestudy + "/moproco/" + str(i) + "/src" for i in range(1, 6)]
        moproco_variance, moproco_diffs = compute_pairwise_diff(moproco_roots)
        print("Variance:", "{:.4f}".format(moproco_variance) + "  ")
        print("Pairwise diffs:", ["{:.4f}".format(d) for d in moproco_diffs])
        print()
